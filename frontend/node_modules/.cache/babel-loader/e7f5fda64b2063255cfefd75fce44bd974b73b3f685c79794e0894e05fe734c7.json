{"ast":null,"code":"import { decoder } from \"tetris-fumen\";\nimport { compressToEncodedURIComponent } from \"lz-string\";\nexport default async function parseReplay(txt) {\n  const target = \"jstris.jezevec10.com\";\n  if (txt.indexOf(target) < 0) return codeToFumen(txt);\n  const parts = txt.split(\"/\");\n  if (parts.length < 5) {\n    throw new Error(\"\");\n  }\n  if (parts[3] != \"replay\" || !parts[2].endsWith(target)) {\n    throw new Error(\"\");\n  }\n  let id = parts[4];\n  if (parts.length > 5) {\n    id = parts[5];\n  }\n  const url = \"https://corsproxy.io/?\".concat(encodeURIComponent(\"https://\".concat(parts[2], \"/replay/data?id=\").concat(id, \"&type=0\")));\n  const response = await fetch(url);\n  if (!response.ok) {\n    throw new Error(\"\");\n  }\n  const text = await response.text();\n  const comp = compressToEncodedURIComponent(text);\n  return await codeToFumen(comp);\n  //return null;\n}\nasync function codeToFumen(replayCode) {\n  const response = await fetch(\"https://fumen.tstman.net/jstris\", {\n    method: \"POST\",\n    headers: {\n      Accept: \"application/json\",\n      \"Content-Type\": \"application/json\"\n    },\n    body: \"replay=\".concat(replayCode)\n  });\n  if (!response.ok) {\n    throw new Error(\"\");\n  }\n  const data = await response.json();\n  return parseFumen(data.fumen);\n\n  //return null;\n}\nfunction parseFumen(fumenUrl) {\n  const pages = decoder.decode(fumenUrl);\n  const ret = [];\n  let curStateArrays = [];\n  let curPCNumber = 0;\n  let curPCLoopIndicator = 1;\n  for (let idx = 0; idx < pages.length; idx++) {\n    const page = pages[idx];\n    let board = \"\";\n    let hasMino = false;\n    for (let y = 3; y >= 0; y--) {\n      for (let x = 0; x < 10; x++) {\n        const mino = page.field.at(x, y);\n        if (mino !== \"_\") {\n          board += mino;\n          hasMino = true;\n        } else {\n          board += \"N\";\n        }\n      }\n    }\n    let queue = \"\";\n    const comment = page.comment;\n    let i;\n    if (comment[4] !== ']') {\n      queue = comment[4] + comment[7];\n      i = 9;\n    } else {\n      queue = comment[6];\n      i = 8;\n    }\n    while (queue.length < 7 && i < comment.length) {\n      queue += comment[i];\n      i += 1;\n    }\n    if (!hasMino && curStateArrays.length > 0) {\n      ret.push({\n        PCNumber: curPCNumber,\n        PCLoopIndicator: curPCLoopIndicator,\n        stateArray: curStateArrays\n      });\n      console.log(ret);\n      curStateArrays = [];\n      curPCNumber += 1;\n      curPCLoopIndicator = idx * 5 % 7 + 1;\n    }\n    // Probably end of the replay\n    if (queue.length === 7) {\n      curStateArrays.push({\n        board: board,\n        queue: queue,\n        placedBlocks: idx\n      });\n    } else if (idx < pages.length - 1) {\n      throw new Error(\"\");\n    }\n  }\n  if (curStateArrays.length > 0) {\n    ret.push({\n      PCNumber: curPCNumber,\n      PCLoopIndicator: curPCLoopIndicator,\n      stateArray: curStateArrays\n    });\n  }\n  return ret;\n}","map":{"version":3,"names":["decoder","compressToEncodedURIComponent","parseReplay","txt","target","indexOf","codeToFumen","parts","split","length","Error","endsWith","id","url","concat","encodeURIComponent","response","fetch","ok","text","comp","replayCode","method","headers","Accept","body","data","json","parseFumen","fumen","fumenUrl","pages","decode","ret","curStateArrays","curPCNumber","curPCLoopIndicator","idx","page","board","hasMino","y","x","mino","field","at","queue","comment","i","push","PCNumber","PCLoopIndicator","stateArray","console","log","placedBlocks"],"sources":["C:/Stuff/Github/peasea/src/scripts/upload.tsx"],"sourcesContent":["import { decoder } from \"tetris-fumen\";\r\nimport { compressToEncodedURIComponent } from \"lz-string\";\r\n\r\nexport default async function parseReplay(txt: string) {\r\n    const target = \"jstris.jezevec10.com\";\r\n    if (txt.indexOf(target) < 0) return codeToFumen(txt);\r\n    const parts = txt.split(\"/\");\r\n    if (parts.length < 5) {\r\n        throw new Error(\"\");\r\n    }\r\n    if (parts[3] != \"replay\" || !parts[2].endsWith(target)) {\r\n        throw new Error(\"\");\r\n    }\r\n\r\n    let id = parts[4];\r\n    if (parts.length > 5) {\r\n        id = parts[5];\r\n    }\r\n\r\n    const url = `https://corsproxy.io/?${encodeURIComponent(\r\n        `https://${parts[2]}/replay/data?id=${id}&type=0`\r\n    )}`;\r\n    const response = await fetch(url);\r\n    if (!response.ok) {\r\n        throw new Error(\"\");\r\n    }\r\n    const text = await response.text();\r\n    const comp = compressToEncodedURIComponent(text);\r\n\r\n    return await codeToFumen(comp);\r\n    //return null;\r\n}\r\n\r\nasync function codeToFumen(replayCode: string) {\r\n    const response = await fetch(`https://fumen.tstman.net/jstris`, {\r\n        method: \"POST\",\r\n        headers: {\r\n            Accept: \"application/json\",\r\n            \"Content-Type\": \"application/json\",\r\n        },\r\n        body: `replay=${replayCode}`,\r\n    });\r\n    if (!response.ok) {\r\n        throw new Error(\"\");\r\n    }\r\n    const data = await response.json();\r\n    return parseFumen(data.fumen);\r\n\r\n    //return null;\r\n}\r\n\r\n\r\n\r\nfunction parseFumen(fumenUrl : string) {\r\n  const pages = decoder.decode(fumenUrl)\r\n\r\n  const ret = []\r\n  let curStateArrays = []\r\n  let curPCNumber = 0\r\n  let curPCLoopIndicator = 1\r\n  for (let idx = 0; idx < pages.length; idx++) {\r\n    const page = pages[idx]\r\n\r\n    let board = \"\"\r\n    let hasMino = false\r\n    for (let y = 3; y >= 0; y--) {\r\n      for (let x = 0; x < 10; x++) {\r\n        const mino = page.field.at(x, y)\r\n        if (mino !== \"_\") {\r\n          board += mino\r\n          hasMino = true\r\n        } else {\r\n          board += \"N\"\r\n        }\r\n      }\r\n    }\r\n\r\n    let queue = \"\"\r\n    const comment = page.comment\r\n    let i;\r\n    if (comment[4] !== ']') {\r\n      queue = comment[4] + comment[7]\r\n      i = 9\r\n    } else {\r\n      queue = comment[6]\r\n      i = 8\r\n    }\r\n\r\n    while (queue.length < 7 && i < comment.length) {\r\n      queue += comment[i]\r\n      i += 1\r\n    }\r\n\r\n    if (!hasMino && curStateArrays.length > 0) {\r\n      ret.push({\r\n        PCNumber: curPCNumber,\r\n        PCLoopIndicator: curPCLoopIndicator,\r\n        stateArray: curStateArrays\r\n      })\r\n      console.log(ret);\r\n      \r\n      curStateArrays = []\r\n      curPCNumber += 1\r\n      curPCLoopIndicator = ((idx * 5) % 7) + 1;\r\n    }\r\n    // Probably end of the replay\r\n    if (queue.length === 7) {\r\n      curStateArrays.push({\r\n        board: board,\r\n        queue: queue,\r\n        placedBlocks: idx\r\n      })\r\n    } else if (idx < pages.length - 1) {\r\n      throw new Error(\"\");\r\n    }\r\n  }\r\n  if (curStateArrays.length > 0) {\r\n    ret.push({\r\n      PCNumber: curPCNumber,\r\n      PCLoopIndicator: curPCLoopIndicator,\r\n      stateArray: curStateArrays\r\n    })\r\n  }\r\n  return ret;\r\n}"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}